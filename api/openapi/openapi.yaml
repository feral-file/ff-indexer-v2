openapi: 3.0.3
info:
  title: Feral File Indexer API
  description: |
    REST API for the Feral File blockchain indexer service.
    
    This API provides access to indexed NFT token data from multiple blockchains,
    including ownership information, metadata, provenance events, and change tracking.
    
    ## Supported Blockchains
    - Ethereum (mainnet, sepolia)
    - Tezos (mainnet, ghostnet)
    
    ## Features
    - Token querying with flexible filters
    - Ownership tracking across multiple chains
    - Provenance event history
    - Metadata enrichment from vendor APIs
    - Change journal for tracking data updates
    - Token indexing triggers
  version: 1.0.0
  contact:
    name: Feral File
    url: https://feralfile.com

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: tokens
    description: Token data and metadata operations
  - name: changes
    description: Change tracking and journal operations
  - name: health
    description: Health check operations

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the API service
      operationId: healthCheck
      tags:
        - health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: ff-indexer-api

  /api/v1/tokens/{cid}:
    get:
      summary: Get token by CID
      description: |
        Retrieves a single token by its canonical token identifier (CID).
        
        The token CID format is: `{chain}:{standard}:{contract_address}:{token_number}`
        
        Examples:
        - `eip155:1:erc721:0xabc123:1234`
        - `tezos:mainnet:fa2:KT1abc123:5678`
        
        ## Expansions
        You can expand related data using the `expand` query parameter:
        - `owners` - Include paginated owner information
        - `provenance_events` - Include paginated provenance events
        - `enrichment_source` - Include vendor enrichment data
        
        ## Sub-resource Pagination
        When expanding owners or provenance_events, you can control pagination:
        - `owners.limit` - Limit number of owners (default: 10, max: 100)
        - `owners.offset` - Offset for owners pagination
        - `provenance_events.limit` - Limit number of events (default: 10, max: 100)
        - `provenance_events.offset` - Offset for events pagination
        - `provenance_events.order` - Sort order for events (asc/desc, default: desc)
      operationId: getToken
      tags:
        - tokens
      parameters:
        - name: cid
          in: path
          required: true
          description: Token CID in format `{chain}:{standard}:{contract_address}:{token_number}`
          schema:
            type: string
            pattern: '^(eip155:\d+|tezos:(mainnet|ghostnet)):(erc721|erc1155|fa2):.+:\d+$'
          example: "eip155:1:erc721:0xabc123:1234"
        - name: expand
          in: query
          description: Comma-separated list of expansions to include
          schema:
            type: array
            items:
              type: string
              enum: [owners, provenance_events, enrichment_source]
          style: form
          explode: false
          example: ["owners", "provenance_events"]
        - name: owners.limit
          in: query
          description: Maximum number of owners to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: owners.offset
          in: query
          description: Offset for owners pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.limit
          in: query
          description: Maximum number of provenance events to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: provenance_events.offset
          in: query
          description: Offset for provenance events pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.order
          in: query
          description: Sort order for provenance events by timestamp
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Token found and returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Bad request - Invalid token CID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens:
    get:
      summary: List tokens
      description: |
        Retrieves a paginated list of tokens with optional filtering.
        
        ## Filters
        Multiple filter values can be provided for each filter parameter.
        All filters are applied with AND logic between different filter types,
        and OR logic within the same filter type.
        
        Examples:
        - Filter by owners: `?owner=0xabc123&owner=0xdef456`
        - Filter by chain: `?chain=eip155:1&chain=tezos:mainnet`
        - Filter by contract: `?contract_address=0xabc123`
        - Combine filters: `?owner=0xabc123&chain=eip155:1`
        
        ## Pagination
        Use `limit` and `offset` for pagination:
        - `limit` - Number of items per page (default: 20, max: 100)
        - `offset` - Starting position (default: 0)
        
        ## Expansions
        Same expansion options as GET /api/v1/tokens/{cid}
      operationId: listTokens
      tags:
        - tokens
      parameters:
        - name: owner
          in: query
          description: Filter by owner address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123", "tz1abc123"]
        - name: chain
          in: query
          description: Filter by blockchain chain(s) - supports multiple values
          schema:
            type: array
            items:
              $ref: '#/components/schemas/Chain'
          style: form
          explode: true
          example: ["eip155:1"]
        - name: contract_address
          in: query
          description: Filter by contract address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123"]
        - name: token_id
          in: query
          description: Filter by token ID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
              pattern: '^\d+$'
          style: form
          explode: true
          example: ["1234", "5678"]
        - name: limit
          in: query
          description: Maximum number of tokens to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Offset for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: expand
          in: query
          description: Comma-separated list of expansions to include
          schema:
            type: array
            items:
              type: string
              enum: [owners, provenance_events, enrichment_source]
          style: form
          explode: false
          example: ["owners"]
        - name: owners.limit
          in: query
          description: Maximum number of owners to return per token (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: owners.offset
          in: query
          description: Offset for owners pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.limit
          in: query
          description: Maximum number of provenance events to return per token (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: provenance_events.offset
          in: query
          description: Offset for provenance events pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.order
          in: query
          description: Sort order for provenance events by timestamp
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Tokens retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenListResponse'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/changes:
    get:
      summary: Get changes
      description: |
        Retrieves a paginated list of changes from the changes journal.
        
        The changes journal tracks all modifications to indexed data, including:
        - Token changes (mint, burn)
        - Owner changes (transfers)
        - Balance changes (for ERC1155/FA2)
        - Metadata changes
        - Media asset changes
        
        ## Filters
        - `token_cid` - Filter by token CID(s)
        - `address` - Filter by address(es) involved in the change
        - `since` - Only show changes after this timestamp (RFC3339 format)
        
        ## Pagination & Ordering
        - `limit` - Number of items per page (default: 20, max: 100)
        - `offset` - Starting position (default: 0)
        - `order` - Sort order by changed_at (asc/desc, default: asc)
        
        ## Expansions
        - `subject` - Include the full subject data based on subject_type
      operationId: getChanges
      tags:
        - changes
      parameters:
        - name: token_cid
          in: query
          description: Filter by token CID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["eip155:1:erc721:0xabc123:1234"]
        - name: address
          in: query
          description: Filter by address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123"]
        - name: since
          in: query
          description: Only show changes after this timestamp (RFC3339 format)
          schema:
            type: string
            format: date-time
          example: "2024-01-01T00:00:00Z"
        - name: limit
          in: query
          description: Maximum number of changes to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Offset for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: order
          in: query
          description: Sort order by changed_at timestamp
          schema:
            type: string
            enum: [asc, desc]
            default: asc
        - name: expand
          in: query
          description: Comma-separated list of expansions to include
          schema:
            type: array
            items:
              type: string
              enum: [subject]
          style: form
          explode: false
          example: ["subject"]
      responses:
        '200':
          description: Changes retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangeListResponse'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens/index:
    post:
      summary: Trigger token indexing
      description: |
        Triggers indexing workflows for one or more tokens or addresses.
        
        This endpoint accepts either:
        - A list of token CIDs (up to 20)
        - A list of addresses (up to 5)
        
        You cannot provide both token CIDs and addresses in the same request.
        
        ## Token CIDs
        When providing token CIDs, the indexer will re-index those specific tokens,
        including metadata, provenance events, and media assets.
        
        ## Addresses
        When providing addresses, the indexer will index all tokens owned by those addresses.
        
        ## Response
        Returns a workflow ID and run ID that can be used to track the indexing progress.
      operationId: triggerTokenIndexing
      tags:
        - tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerIndexingRequest'
      responses:
        '202':
          description: Indexing triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerIndexingResponse'
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

components:
  schemas:
    Chain:
      type: string
      description: |
        Blockchain network identifier using CAIP-2 format.
        
        Supported chains:
        - `eip155:1` - Ethereum Mainnet
        - `eip155:11155111` - Ethereum Sepolia (testnet)
        - `tezos:mainnet` - Tezos Mainnet
        - `tezos:ghostnet` - Tezos Ghostnet (testnet)
      enum:
        - eip155:1
        - eip155:11155111
        - tezos:mainnet
        - tezos:ghostnet
      example: eip155:1

    ChainStandard:
      type: string
      description: |
        Blockchain token standard.
        
        Supported standards:
        - `erc721` - Ethereum ERC-721 (non-fungible token)
        - `erc1155` - Ethereum ERC-1155 (multi-token)
        - `fa2` - Tezos FA2 (Financial Application 2)
      enum:
        - erc721
        - erc1155
        - fa2
      example: erc721

    SubjectType:
      type: string
      description: |
        Type of entity that was changed in the changes journal.
        
        Subject types:
        - `token` - Change to token data (mint, burn, etc.)
        - `owner` - Change in token ownership (transfer)
        - `balance` - Change in token balance (for ERC1155/FA2)
        - `metadata` - Change in token metadata
        - `media` - Change in media asset status or URLs
      enum:
        - token
        - owner
        - balance
        - metadata
        - media
      example: token

    ProvenanceEventType:
      type: string
      description: |
        Type of provenance event.
        
        Event types:
        - `mint` - Token creation/minting
        - `transfer` - Token ownership transfer
        - `burn` - Token destruction
        - `metadata_update` - Metadata was updated on-chain
      enum:
        - mint
        - transfer
        - burn
        - metadata_update
      example: mint

    EnrichmentLevel:
      type: string
      description: |
        Level of metadata enrichment applied.
        
        Enrichment levels:
        - `none` - No enrichment applied
        - `origin` - Basic on-chain metadata only
        - `vendor` - Enriched with vendor API data
        - `enhanced` - Fully enhanced with all available data
      example: vendor

    TokenResponse:
      type: object
      required:
        - id
        - token_cid
        - chain
        - standard
        - contract_address
        - token_number
        - burned
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database ID
          example: 12345
        token_cid:
          type: string
          description: Canonical token identifier in format `{chain}:{standard}:{contract_address}:{token_number}`
          example: "eip155:1:erc721:0xabc123:1234"
        chain:
          $ref: '#/components/schemas/Chain'
        standard:
          $ref: '#/components/schemas/ChainStandard'
        contract_address:
          type: string
          description: Smart contract address
          example: "0xabc123def456"
        token_number:
          type: string
          description: Token ID/number as a string (supports large numbers)
          example: "1234"
        current_owner:
          type: string
          nullable: true
          description: Current owner address (null for multi-owner tokens like ERC1155/FA2)
          example: "0xowner123"
        burned:
          type: boolean
          description: Whether the token has been burned
          example: false
        created_at:
          type: string
          format: date-time
          description: Timestamp when the token was first indexed
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the token was last updated
          example: "2024-01-02T12:00:00Z"
        metadata:
          $ref: '#/components/schemas/TokenMetadataResponse'
          nullable: true
        owners:
          $ref: '#/components/schemas/PaginatedOwners'
          nullable: true
        provenance_events:
          $ref: '#/components/schemas/PaginatedProvenanceEvents'
          nullable: true
        enrichment_source:
          $ref: '#/components/schemas/EnrichmentSourceResponse'
          nullable: true

    TokenMetadataResponse:
      type: object
      required:
        - token_id
        - enrichment_level
      properties:
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        origin_json:
          type: object
          description: Original on-chain metadata JSON
          nullable: true
          example: {"name": "Token #1234", "description": "Original metadata"}
        latest_json:
          type: object
          description: Latest enriched metadata JSON
          nullable: true
          example: {"name": "Token #1234", "description": "Enriched metadata", "artist": "Artist Name"}
        latest_hash:
          type: string
          nullable: true
          description: Hash of the latest metadata
          example: "abc123hash"
        enrichment_level:
          $ref: '#/components/schemas/EnrichmentLevel'
        last_refreshed_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when metadata was last refreshed
          example: "2024-01-02T12:00:00Z"
        image_url:
          type: string
          nullable: true
          description: Primary image URL
          example: "https://example.com/image.png"
        animation_url:
          type: string
          nullable: true
          description: Animation/video URL
          example: "https://example.com/animation.mp4"
        name:
          type: string
          nullable: true
          description: Token name
          example: "Token #1234"
        description:
          type: string
          nullable: true
          description: Token description
          example: "A unique digital artwork"
        artists:
          type: array
          items:
            $ref: '#/components/schemas/ArtistResponse'
          description: List of artists/creators
        publisher:
          $ref: '#/components/schemas/PublisherResponse'
          nullable: true

    ArtistResponse:
      type: object
      properties:
        did:
          type: string
          description: Decentralized identifier for the artist
          example: "did:pkh:tez:tz1abc123"
        name:
          type: string
          description: Artist name
          example: "Artist Name"

    PublisherResponse:
      type: object
      properties:
        name:
          type: string
          nullable: true
          description: Publisher name
          example: "Feral File"
        url:
          type: string
          nullable: true
          description: Publisher URL
          example: "https://feralfile.com"

    OwnerResponse:
      type: object
      required:
        - owner_address
        - quantity
        - created_at
        - updated_at
      properties:
        owner_address:
          type: string
          description: Owner's blockchain address
          example: "0xowner123"
        quantity:
          type: string
          description: Quantity owned (as string to support large numbers)
          example: "1"
        created_at:
          type: string
          format: date-time
          description: Timestamp when ownership was first recorded
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when ownership was last updated
          example: "2024-01-02T12:00:00Z"

    PaginatedOwners:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/OwnerResponse'
          description: List of owners
        offset:
          type: integer
          format: uint64
          nullable: true
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of owners
          example: 100

    ProvenanceEventResponse:
      type: object
      required:
        - id
        - token_id
        - chain
        - event_type
        - timestamp
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database ID
          example: 67890
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        chain:
          $ref: '#/components/schemas/Chain'
        event_type:
          $ref: '#/components/schemas/ProvenanceEventType'
        from_address:
          type: string
          nullable: true
          description: Sender address (null for mint events)
          example: "0xfrom123"
        to_address:
          type: string
          nullable: true
          description: Recipient address (null for burn events)
          example: "0xto456"
        quantity:
          type: string
          nullable: true
          description: Quantity transferred (as string to support large numbers)
          example: "1"
        tx_hash:
          type: string
          nullable: true
          description: Transaction hash
          example: "0xtxhash123"
        block_number:
          type: integer
          format: uint64
          nullable: true
          description: Block number
          example: 12345678
        block_hash:
          type: string
          nullable: true
          description: Block hash
          example: "0xblockhash456"
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
          example: "2024-01-01T00:00:00Z"
        raw:
          type: object
          nullable: true
          description: Raw event data as JSON
          example: {"log_index": 10, "transaction_index": 5}
        created_at:
          type: string
          format: date-time
          description: Timestamp when event was indexed
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when event was last updated
          example: "2024-01-01T00:00:00Z"

    PaginatedProvenanceEvents:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ProvenanceEventResponse'
          description: List of provenance events
        offset:
          type: integer
          format: uint64
          nullable: true
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of events
          example: 50

    EnrichmentSourceResponse:
      type: object
      required:
        - token_id
        - vendor
        - created_at
        - updated_at
      properties:
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        vendor:
          type: string
          description: Vendor/source name (e.g., "artblocks", "fxhash")
          example: "artblocks"
        vendor_json:
          type: object
          nullable: true
          description: Raw vendor API response as JSON
          example: {"project_name": "Chromie Squiggle", "series": 0}
        vendor_hash:
          type: string
          nullable: true
          description: Hash of vendor data
          example: "vendor123hash"
        image_url:
          type: string
          nullable: true
          description: Image URL from vendor
          example: "https://vendor.com/image.png"
        animation_url:
          type: string
          nullable: true
          description: Animation URL from vendor
          example: "https://vendor.com/animation.mp4"
        name:
          type: string
          nullable: true
          description: Token name from vendor
          example: "Chromie Squiggle #1234"
        description:
          type: string
          nullable: true
          description: Token description from vendor
          example: "A unique generative artwork"
        artists:
          type: array
          items:
            $ref: '#/components/schemas/ArtistResponse'
          description: Artists from vendor data
        created_at:
          type: string
          format: date-time
          description: Timestamp when enrichment was created
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when enrichment was last updated
          example: "2024-01-02T12:00:00Z"

    TokenListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TokenResponse'
          description: List of tokens
        offset:
          type: integer
          format: uint64
          nullable: true
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of tokens matching the filter
          example: 1000

    ChangeResponse:
      type: object
      required:
        - id
        - token_cid
        - subject_type
        - subject_id
        - changed_at
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database ID
          example: 99999
        token_cid:
          type: string
          description: Token CID that was affected
          example: "eip155:1:erc721:0xabc123:1234"
        subject_type:
          $ref: '#/components/schemas/SubjectType'
        subject_id:
          type: string
          description: |
            Polymorphic reference to the subject that changed:
            - For 'token'/'owner': provenance_event_id
            - For 'balance': balance_id
            - For 'metadata': token_id
            - For 'media': media_asset_id
          example: "67890"
        changed_at:
          type: string
          format: date-time
          description: Timestamp when the change occurred
          example: "2024-01-02T12:00:00Z"
        meta:
          type: object
          nullable: true
          description: Additional context about the change as JSON
          example: {"fields_changed": ["name", "description"]}
        created_at:
          type: string
          format: date-time
          description: Timestamp when change was recorded
          example: "2024-01-02T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when change was last updated
          example: "2024-01-02T12:00:00Z"
        subject:
          nullable: true
          description: Expanded subject data (available when expand=subject)
          oneOf:
            - $ref: '#/components/schemas/TokenResponse'
            - $ref: '#/components/schemas/OwnerResponse'
            - $ref: '#/components/schemas/TokenMetadataResponse'

    ChangeListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ChangeResponse'
          description: List of changes
        offset:
          type: integer
          format: uint64
          nullable: true
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of changes matching the filter
          example: 500

    TriggerIndexingRequest:
      type: object
      properties:
        token_cids:
          type: array
          items:
            type: string
          description: List of token CIDs to index (max 20, mutually exclusive with addresses)
          maxItems: 20
          example: ["eip155:1:erc721:0xabc123:1234", "eip155:1:erc721:0xabc123:5678"]
        addresses:
          type: array
          items:
            type: string
          description: List of addresses to index all tokens for (max 5, mutually exclusive with token_cids)
          maxItems: 5
          example: ["0xowner123", "tz1abc123"]

    TriggerIndexingResponse:
      type: object
      required:
        - workflow_id
        - run_id
      properties:
        workflow_id:
          type: string
          description: Temporal workflow ID for tracking
          example: "index-workflow-123"
        run_id:
          type: string
          description: Temporal run ID for tracking
          example: "run-456"

    APIError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          enum:
            - bad_request
            - not_found
            - validation_failed
            - unauthorized
            - forbidden
            - internal_error
            - database_error
            - service_error
          example: validation_failed
        message:
          type: string
          description: Human-readable error message
          example: "Validation failed"
        details:
          type: string
          description: Additional error details
          example: "Invalid token CID format"
