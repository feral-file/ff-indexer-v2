openapi: 3.1.1
info:
  title: Feral File Indexer API
  description: |
    REST API for the Feral File blockchain indexer service.
    
    This API provides access to indexed NFT token data from multiple blockchains,
    including ownership information, metadata, provenance events, and change tracking.
    
    ## Supported Blockchains
    - Ethereum (mainnet, sepolia)
    - Tezos (mainnet, ghostnet)
    
    ## Features
    - Token querying with flexible filters
    - Ownership tracking across multiple chains
    - Provenance event history
    - Metadata enrichment from vendor APIs
    - Change journal for tracking data updates
    - Token indexing triggers
    - Metadata refresh triggers
    
    ## Authentication
    Some endpoints require authentication:
    - REST: `POST /api/v1/tokens/owners/index` (deprecated, use `/api/v1/tokens/addresses/index` instead)
    - REST: `POST /api/v1/tokens/addresses/index` (trigger token indexing by owner addresses with job tracking)
    - GraphQL: `triggerOwnerIndexing` mutation (deprecated, use `triggerAddressIndexing` instead)
    - GraphQL: `triggerAddressIndexing` mutation (queries, `triggerTokenIndexing`, and `triggerMetadataIndexing` mutations are public)
    
    Two authentication methods are supported:
    
    ### JWT (Bearer Token)
    Use the `Authorization: Bearer <token>` header with a valid JWT token signed with RSA (RS256/RS384/RS512).
    
    ### API Key
    Use the `Authorization: ApiKey <key>` header with a valid API key.
    
    Contact your system administrator to obtain authentication credentials.
  version: 1.0.0
  contact:
    name: Feral File
    url: https://feralfile.com

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: tokens
    description: Token data and metadata operations
  - name: changes
    description: Change tracking and journal operations
  - name: workflows
    description: Temporal workflow status and tracking operations
  - name: indexing
    description: Address indexing job tracking operations
  - name: webhooks
    description: Webhook client registration and management operations
  - name: health
    description: Health check operations

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the API service
      operationId: healthCheck
      tags:
        - health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: ff-indexer-api

  /api/v1/tokens/{cid}:
    get:
      summary: Get token by CID
      description: |
        Retrieves a single token by its canonical token identifier (CID).
        
        The token CID format is: `{chain}:{standard}:{contract_address}:{token_number}`
        
        Examples:
        - `eip155:1:erc721:0xabc123:1234`
        - `tezos:mainnet:fa2:KT1abc123:5678`
        
        ## Expansions
        You can expand related data using the `expand` query parameter:
        - `metadata` - Include token metadata
        - `owners` - Include paginated owner information
        - `provenance_events` - Include paginated provenance events
        - `enrichment_source` - Include vendor enrichment data
        - `display` - Include unified display field (merges metadata and enrichment source, with enrichment taking precedence)
        - `media_asset` - Include media assets based on requested expansions
        - `metadata_media_assets` - (Deprecated) Include media assets for token metadata only
        - `enrichment_source_media_assets` - (Deprecated) Include media assets for enrichment source only
        
        **Note**: The `media_asset` expansion behavior depends on other requested expansions:
        - With `metadata` only: includes media assets from metadata
        - With `enrichment_source` only: includes media assets from enrichment source
        - With `display` only: includes media assets for URLs in the merged display (respects enrichment precedence)
        - With `metadata` + `enrichment_source`: includes media assets from both sources
        - With `metadata` + `display`: includes media from metadata + display merged URLs
        - Without any source expansion: returns empty array
        
        ## Sub-resource Pagination
        When expanding owners or provenance_events, you can control pagination:
        - `owners.limit` - Limit number of owners (default: 20, max: 255)
        - `owners.offset` - Offset for owners pagination
        - `provenance_events.limit` - Limit number of events (default: 20, max: 255)
        - `provenance_events.offset` - Offset for events pagination
        - `provenance_events.order` - Sort order for events (asc/desc, default: desc)
      operationId: getToken
      tags:
        - tokens
      parameters:
        - name: cid
          in: path
          required: true
          description: Token CID in format `{chain}:{standard}:{contract_address}:{token_number}`
          schema:
            type: string
            pattern: '^(eip155:\d+|tezos:(mainnet|ghostnet)):(erc721|erc1155|fa2):.+:\d+$'
          example: "eip155:1:erc721:0xabc123:1234"
        - name: expand
          in: query
          description: Comma-separated list of expansions to include
          schema:
            type: array
            items:
              type: string
              enum: [metadata, owners, provenance_events, enrichment_source, display, media_asset, metadata_media_assets, enrichment_source_media_assets]
          style: form
          explode: false
          example: ["display", "media_asset"]
        - name: owners.limit
          in: query
          description: Maximum number of owners to return (max 255)
          schema:
            type: integer
            minimum: 1
            maximum: 255
            default: 20
        - name: owners.offset
          in: query
          description: Offset for owners pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.limit
          in: query
          description: Maximum number of provenance events to return (max 255)
          schema:
            type: integer
            minimum: 1
            maximum: 255
            default: 20
        - name: provenance_events.offset
          in: query
          description: Offset for provenance events pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: provenance_events.order
          in: query
          description: Sort order for provenance events by timestamp
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Token found and returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Bad request - Invalid token CID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens:
    get:
      summary: List tokens
      description: |
        Retrieves a paginated list of tokens with optional filtering and sorting.
        
        ## Filters
        Multiple filter values can be provided for each filter parameter.
        All filters are applied with AND logic between different filter types,
        and OR logic within the same filter type.
        
        Examples:
        - Filter by owners: `?owner=0xabc123&owner=0xdef456`
        - Filter by chain: `?chain=eip155:1&chain=tezos:mainnet`
        - Filter by contract: `?contract_address=0xabc123`
        - Filter by token number: `?token_number=1234&token_number=5678`
        - Filter by token ID: `?token_id=12345&token_id=67890`
        - Filter by token CID: `?token_cid=eip155:1:erc721:0xabc123:1234`
        - Combine filters: `?owner=0xabc123&chain=eip155:1`
        
        ## Sorting
        Control the sort order of results:
        - `sort_by` - Field to sort by (default: `latest_provenance`)
          - `created_at` - Sort by token creation timestamp
          - `latest_provenance` - Sort by latest provenance event timestamp (respects owner filter when provided) (default)
        - `sort_order` - Sort direction (default: `desc`)
          - `asc` - Ascending order (oldest first)
          - `desc` - Descending order (newest first)
        
        Examples:
        - Sort by creation date, newest first: `?sort_by=created_at&sort_order=desc`
        - Sort by creation date, oldest first: `?sort_by=created_at&sort_order=asc`
        - Sort by latest activity: `?sort_by=latest_provenance&sort_order=desc` (default)
        - Sort by latest activity for specific owner: `?owner=0xabc123&sort_by=latest_provenance&sort_order=desc`
        
        ## Pagination
        Use `limit` and `offset` for pagination:
        - `limit` - Number of items per page (default: 20, max: 255)
        - `offset` - Starting position (default: 0)
        
        ## Expansions
        You can expand related data using the `expand` query parameter:
        - `metadata` - Include token metadata
        - `owners` - Include owner information (first 20 items per token)
        - `provenance_events` - Include provenance events (first 20 items per token, ordered by timestamp DESC)
        - `enrichment_source` - Include vendor enrichment data
        - `display` - Include unified display field (merges metadata and enrichment source, with enrichment taking precedence)
        - `media_asset` - Include media assets based on requested expansions
        - `metadata_media_assets` - (Deprecated) Include media assets for token metadata only
        - `enrichment_source_media_assets` - (Deprecated) Include media assets for enrichment source only
        
        **Note**: The `media_asset` expansion behavior depends on other requested expansions:
        - With `metadata` only: includes media assets from metadata
        - With `enrichment_source` only: includes media assets from enrichment source
        - With `display` only: includes media assets for URLs in the merged display (respects enrichment precedence)
        - With `metadata` + `enrichment_source`: includes media assets from both sources
        - With `metadata` + `display`: includes media from metadata + display merged URLs
        - Without any source expansion: returns empty array
        
        **Important**: When querying multiple tokens, the `owners` and `provenance_events` expansions return a fixed number of items (first 20) per token.
        Pagination parameters (`owners.limit`, `owners.offset`, `provenance_events.limit`, `provenance_events.offset`, `provenance_events.order`) are NOT supported for this endpoint.
        Use `GET /api/v1/tokens/{cid}` for paginated owners and provenance events for individual tokens.
      operationId: listTokens
      tags:
        - tokens
      parameters:
        - name: owner
          in: query
          description: Filter by owner address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123", "tz1abc123"]
        - name: chain
          in: query
          description: Filter by blockchain chain(s) - supports multiple values
          schema:
            type: array
            items:
              $ref: '#/components/schemas/Chain'
          style: form
          explode: true
          example: ["eip155:1"]
        - name: contract_address
          in: query
          description: Filter by contract address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123"]
        - name: token_id
          in: query
          description: Filter by internal database token ID(s) - supports multiple values
          schema:
            type: array
            items:
              type: integer
              format: uint64
          style: form
          explode: true
          example: [12345, 67890]
        - name: token_number
          in: query
          description: Filter by token number(s) within contract - supports multiple values
          schema:
            type: array
            items:
              type: string
              pattern: '^\d+$'
          style: form
          explode: true
          example: ["1234", "5678"]
        - name: token_cid
          in: query
          description: Filter by token CID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["eip155:1:erc721:0xabc123:1234"]
        - name: include_unviewable
          in: query
          description: Include tokens with unviewable media (no accessible media URLs). Default is false - only tokens with accessible media are returned.
          schema:
            type: boolean
            default: false
          example: false
        - name: sort_by
          in: query
          description: |
            Field to sort tokens by.
            
            Sort options:
            - `created_at` - Sort by token creation timestamp
            - `latest_provenance` - Sort by latest provenance event timestamp. When owner filter is provided, sorts by the latest provenance event for those specific owners. Without owner filter, uses the token's last provenance timestamp. (default)
          schema:
            type: string
            enum: [created_at, latest_provenance]
            default: latest_provenance
          example: latest_provenance
        - name: sort_order
          in: query
          description: Sort order (ascending or descending)
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          example: desc
        - name: limit
          in: query
          description: Maximum number of tokens to return (max 255)
          schema:
            type: integer
            minimum: 1
            maximum: 255
            default: 20
        - name: offset
          in: query
          description: Offset for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: expand
          in: query
          description: |
            Comma-separated list of expansions to include.
            Note: owners and provenance_events expansions return first 20 items per token without pagination support.
            Use GET /api/v1/tokens/{cid} for paginated results.
          schema:
            type: array
            items:
              type: string
              enum: [metadata, owners, provenance_events, enrichment_source, display, media_asset, metadata_media_assets, enrichment_source_media_assets]
          style: form
          explode: false
          example: ["display", "media_asset"]
      responses:
        '200':
          description: Tokens retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenListResponse'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/changes:
    get:
      summary: Get changes
      description: |
        Retrieves a paginated list of changes from the changes journal.
        
        The changes journal tracks all modifications to indexed data, including:
        - Token changes (mint, burn)
        - Owner changes (transfers)
        - Balance changes (for ERC1155/FA2)
        - Metadata changes
        - Media asset changes
        
        Changes are always returned in ascending order by ID (sequential audit log).
        
        ## Filters
        - `token_id` - Filter by token ID(s) - supports multiple values
        - `token_cid` - Filter by token CID(s)
        - `address` - Filter by address(es) involved in the change
        - `subject_type` - Filter by subject type(s) - supports multiple values
        - `subject_id` - Filter by subject ID(s) - supports multiple values
        - `anchor` - Only show changes after this anchor ID (recommended for cursor-based pagination)
        - `since` - Deprecated: Only show changes after this timestamp (RFC3339 format)
        
        ## Pagination
        - `limit` - Number of items per page (default: 20, max: 255)
        - `anchor` - Recommended: Use next_anchor from previous response for cursor-based pagination
        - `offset` - Deprecated: Starting position (only applies with 'since' parameter, ignored with 'anchor')
        - `order` - Deprecated: Sort order (only applies with 'since' parameter, ignored with 'anchor')
        
        ## Expansions
        - `subject` - Include the full subject data based on subject_type
      operationId: getChanges
      tags:
        - changes
      parameters:
        - name: token_id
          in: query
          description: Filter by token ID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["1234"]
        - name: token_cid
          in: query
          description: Filter by token CID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["eip155:1:erc721:0xabc123:1234"]
        - name: address
          in: query
          description: Filter by address(es) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["0xabc123"]
        - name: subject_type
          in: query
          description: Filter by subject type(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["token"]
        - name: subject_id
          in: query
          description: Filter by subject ID(s) - supports multiple values
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
          example: ["1234"]
        - name: anchor
          in: query
          description: Only show changes after this anchor ID
          schema:
            type: integer
            format: uint64
          example: 1234
        - name: since
          in: query
          description: "Deprecated: Only show changes after this timestamp (RFC3339 format)"
          schema:
            type: string
            format: date-time
          example: "2024-01-01T00:00:00Z"
        - name: limit
          in: query
          description: Maximum number of changes to return (max 255)
          schema:
            type: integer
            minimum: 1
            maximum: 255
            default: 20
        - name: offset
          in: query
          description: "Deprecated: Offset for pagination (only applies when using 'since' parameter, ignored with 'anchor')"
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: order
          in: query
          description: "Deprecated: Sort order (only applies when using 'since' parameter, ignored with 'anchor')"
          schema:
            type: string
            enum: [asc, desc]
            default: asc
        - name: expand
          in: query
          description: Comma-separated list of expansions to include
          schema:
            type: array
            items:
              type: string
              enum: [subject]
          style: form
          explode: false
          example: ["subject"]
      responses:
        '200':
          description: Changes retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangeListResponse'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens/index:
    post:
      summary: Trigger token indexing by CIDs
      description: |
        Triggers indexing workflows for one or more tokens by their CIDs.
        
        This endpoint accepts a list of token CIDs (up to 20) and will re-index those specific tokens,
        including metadata, provenance events, and media assets.
        
        **This endpoint does not require authentication** - it is open for public use.
        
        ## Response
        Returns a workflow ID and run ID that can be used to track the indexing progress.
      operationId: triggerTokenIndexing
      tags:
        - tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerTokenIndexingRequest'
      responses:
        '202':
          description: Indexing triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerIndexingResponse'
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens/owners/index:
    post:
      summary: Trigger token indexing by owner addresses (deprecated)
      deprecated: true
      description: |
        **DEPRECATED**: Use `/api/v1/tokens/addresses/index` instead for better job tracking.
        
        Triggers indexing workflows for all tokens owned by one or more addresses.

        This endpoint accepts a list of owner addresses (up to 5) and creates a single parent
        workflow that processes all addresses sequentially.

        **This endpoint requires authentication** - use JWT Bearer token or API Key.

        ## Response
        Returns a single workflow ID and run ID for tracking the entire indexing operation.
        
        ## Migration Guide
        For better tracking of individual address progress, use the new `/api/v1/tokens/addresses/index` endpoint instead,
        which provides separate workflow IDs for each address.
      operationId: triggerOwnerIndexing
      tags:
        - tokens
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerOwnerIndexingRequest'
      responses:
        '401':
          description: Unauthorized - Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '202':
          description: Indexing triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerIndexingResponse'
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens/addresses/index:
    post:
      summary: Trigger token indexing by owner addresses with job tracking
      description: |
        Triggers indexing workflows for all tokens owned by one or more addresses with enhanced job tracking.

        This endpoint accepts a list of owner addresses (up to 5) and will index all tokens
        owned by those addresses across all supported blockchains. Each address gets its own
        workflow and job record for independent progress tracking.

        **This endpoint requires authentication** - use JWT Bearer token or API Key.

        ## Response
        Returns an array of jobs with workflow IDs that can be used to track each address's indexing progress.
        Each address gets its own workflow ID for independent progress tracking.
        
        ## Job Tracking
        Use the returned workflow IDs with `/api/v1/indexing/jobs/{workflow_id}` to track:
        - Current status (running, paused, completed, failed, canceled)
        - Tokens processed count
        - Current block range being indexed
        - Timestamps for status changes
      operationId: triggerAddressIndexing
      tags:
        - tokens
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerOwnerIndexingRequest'
      responses:
        '401':
          description: Unauthorized - Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '202':
          description: Indexing triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerAddressIndexingResponse'
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/tokens/metadata/index:
    post:
      summary: Trigger metadata refresh by token IDs or CIDs
      description: |
        Triggers metadata refresh workflows for one or more tokens by their IDs or CIDs.
        
        This endpoint accepts either:
        - A list of token IDs (internal database IDs, up to 50)
        - A list of token CIDs (canonical identifiers, up to 50)
        - Or both (at least one is required)
        
        The endpoint will validate that all provided IDs and CIDs exist in the database
        before triggering the metadata refresh workflow. If any token is not found, a 404
        error will be returned with details about which token was not found.
        
        Metadata refresh includes:
        - Fetching latest on-chain metadata
        - Enriching with vendor API data (ArtBlocks, fxhash, etc.)
        - Updating media asset references
        - Refreshing enrichment sources
        
        **This endpoint does not require authentication** - it is open for public use.
        
        ## Response
        Returns a workflow ID and run ID that can be used to track the metadata refresh progress.
        The workflow will trigger child workflows for each token in parallel.
      operationId: triggerMetadataIndexing
      tags:
        - tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerMetadataIndexingRequest'
      responses:
        '202':
          description: Metadata refresh triggered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TriggerIndexingResponse'
        '404':
          description: One or more tokens not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
              examples:
                tokenIdNotFound:
                  summary: Token ID not found
                  value:
                    code: not_found
                    message: Token with ID 12345 not found
                tokenCIDNotFound:
                  summary: Token CID not found
                  value:
                    code: not_found
                    message: Token with CID eip155:1:erc721:0xabc123:9999 not found
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
              examples:
                missingBoth:
                  summary: Missing both token_ids and token_cids
                  value:
                    code: validation_failed
                    message: at least one of token_ids or token_cids is required
                tooManyTokens:
                  summary: Too many tokens provided
                  value:
                    code: validation_failed
                    message: maximum 20 token IDs allowed
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/workflows/{workflow_id}/runs/{run_id}:
    get:
      summary: Get workflow status
      description: |
        Retrieves the status of a Temporal workflow execution by workflow ID and run ID.
        
        This endpoint returns information about the workflow execution, including:
        - Current status (RUNNING, COMPLETED, FAILED, CANCELED, TERMINATED, TIMED_OUT)
        - Start time
        - Close time (if completed)
        - Execution duration (if completed)
      operationId: getWorkflowStatus
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          description: The workflow ID
          schema:
            type: string
          example: "index-tokens-abc123"
        - name: run_id
          in: path
          required: true
          description: The run ID
          schema:
            type: string
          example: "def456"
      responses:
        '200':
          description: Workflow status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowStatusResponse'
        '400':
          description: Bad request - Missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '404':
          description: Workflow execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/indexing/jobs/{workflow_id}:
    get:
      summary: Get indexing job status by workflow ID
      description: |
        Retrieves the status of an address indexing job by its workflow ID.
        
        This endpoint returns information about the indexing job, including:
        - Current status (running, paused, failed, completed, canceled)
        - Address and chain being indexed
        - Progress tracking (tokens processed, block ranges)
        - Timing information (started, paused, completed, failed times)
        - Optional: Total token counts (indexed and viewable)
        
        The workflow ID is returned when you trigger address indexing via the
        `POST /api/v1/tokens/addresses/index` endpoint or the GraphQL `triggerAddressIndexing` mutation.
        
        Each address gets its own workflow and job record for tracking progress independently.
        
        ## Optional Token Counts
        
        By default, this endpoint returns basic job status without computing token counts (for performance).
        You can optionally request token count statistics using query parameters:
        
        - `include_total_indexed=true` - Include only total_tokens_indexed
        - `include_total_viewable=true` - Include only total_tokens_viewable
        
        Token counts:
        - `total_tokens_indexed` - All tokens owned by the address (present in database)
        - `total_tokens_viewable` - Tokens with metadata OR enrichment source (ready for display)
        
        These counts are computed efficiently with a single optimized database query.
      operationId: getAddressIndexingJob
      tags:
        - indexing
      parameters:
        - name: workflow_id
          in: path
          required: true
          description: The workflow ID of the indexing job
          schema:
            type: string
          example: "index-token-owner-0x1234567890123456789012345678901234567890"
        - name: include_total_indexed
          in: query
          description: Include total_tokens_indexed (total tokens owned by address) in the response
          schema:
            type: boolean
            default: false
          example: false
        - name: include_total_viewable
          in: query
          description: Include total_tokens_viewable (tokens with metadata or enrichment) in the response
          schema:
            type: boolean
            default: false
          example: false
      responses:
        '200':
          description: Indexing job status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddressIndexingJobResponse'
        '400':
          description: Bad request - Missing or invalid workflow ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '404':
          description: Indexing job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

  /api/v1/webhooks/clients:
    post:
      summary: Create a new webhook client
      description: |
        Creates a new webhook client that will receive webhook events.
        
        **This endpoint requires API key authentication only** (JWT tokens are not accepted).
        Use the `Authorization: ApiKey <key>` header.
        
        The server will automatically generate:
        - `client_id` - A unique UUID v4 identifier for the client
        - `webhook_secret` - A secure 64-character hex string for HMAC-SHA256 signature verification
        
        The webhook client will be created in an active state (`is_active: true`) by default.
        
        ## Event Filters
        You can subscribe to specific event types or use `["*"]` to receive all events:
        - `token.indexing.queryable` - Token becomes queryable (basic ownership indexed)
        - `token.indexing.viewable` - Token becomes viewable (metadata and enrichment completed, media URLs healthy)
        - `token.indexing.unviewable` - Token becomes unviewable (metadata/enrichment failed or media URLs unhealthy)
        - `token.indexing.provenance_completed` - Full provenance history indexed
        - `token.ownership.minted` - Token was minted
        - `token.ownership.transferred` - Token ownership changed
        - `token.ownership.burned` - Token was burned
        - `token.viewability.changed` - Token viewability changed
        - `*` - Wildcard to receive all event types
        
        ## Response
        Returns the complete webhook client configuration including the generated `client_id` and
        `webhook_secret`. **Save the webhook_secret securely** as it will be needed to verify webhook
        signatures.
      operationId: createWebhookClient
      tags:
        - webhooks
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookClientRequest'
      responses:
        '201':
          description: Webhook client created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookClientResponse'
        '400':
          description: Bad request - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '401':
          description: Unauthorized - Missing or invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '422':
          description: Validation error - Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
              examples:
                invalidURL:
                  summary: Invalid webhook URL
                  value:
                    code: validation_failed
                    message: webhook_url must be a valid HTTPS URL
                emptyFilters:
                  summary: Empty event filters
                  value:
                    code: validation_failed
                    message: event_filters is required and must not be empty
                invalidRetry:
                  summary: Invalid retry attempts
                  value:
                    code: validation_failed
                    message: retry_max_attempts must be between 0 and 10
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

webhooks:
  onTokenEvent:
    post:
      summary: Token Event Notification
      description: |
        The indexer will POST token events to your registered `webhook_url`.
        
        ## Request Headers
        
        Every webhook delivery includes these headers:
        - `Content-Type: application/json`
        - `X-Webhook-Signature: <signature>` - HMAC-SHA256 signature in format `sha256=<hex>`
        - `X-Webhook-Event-ID: <event_id>` - Unique event ID (ULID format)
        - `X-Webhook-Event-Type: <event_type>` - Event type string
        - `X-Webhook-Timestamp: <timestamp>` - Unix timestamp when signature was generated
        
        ## Verifying Signatures
        
        Always verify the `X-Webhook-Signature` to ensure the webhook came from the indexer.
        
        The signature is computed over: `{timestamp}.{event_id}.{json_body}`
        
        ## Response Requirements
        
        Your endpoint should:
        - Return HTTP 2xx status (200, 201, 202, 204) to acknowledge receipt
        - Respond within 30 seconds
        - Process webhooks asynchronously if needed
        
        Non-2xx responses or timeouts will trigger automatic retries with exponential backoff.
        
        ## Event Timing
        
        Events are fired at specific points in the indexing workflow:
        
        ### Indexing Workflow Timeline
        ```
        Token Discovered → Index with minimal provenances
                          ↓ (immediately after)
                          [token.indexing.queryable]
                          ↓
                          Index metadata & enrichment (parallel)
                          ↓ (after metadata/enrichment complete)
                          [token.indexing.viewable]
                          ↓
                          Index full provenance history (parallel, background)
                          ↓ (after all historical events indexed)
                          [token.indexing.provenance_completed]
        ```
        
        ### Ownership Event Timeline
        ```
        Mint Event → Create token & provenance record
                    ↓ (immediately after DB write)
                    [token.ownership.minted]
        
        Transfer Event → Update ownership & balances
                        ↓ (immediately after DB write)
                        [token.ownership.transferred]
        
        Burn Event → Mark token as burned
                    ↓ (immediately after DB write)
                    [token.ownership.burned]
        ```
      tags:
        - webhooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEventPayload'
            examples:
              tokenIndexingQueryable:
                summary: token.indexing.queryable event
                description: |
                  Fired when a token becomes queryable (minimal ownership indexed).
                  After this event, you can query the token by ID and see basic ownership.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J3"
                  event_type: "token.indexing.queryable"
                  timestamp: "2024-01-15T10:30:00Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "1234"
                    address: null
              tokenIndexingViewable:
                summary: token.indexing.viewable event
                description: |
                  Fired when a token becomes viewable (metadata and enrichment complete, media URLs healthy).
                  After this event, the token has full metadata and is ready for display.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J4"
                  event_type: "token.indexing.viewable"
                  timestamp: "2024-01-15T10:30:15Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "1234"
                    address: "0xowner123"
              tokenIndexingUnviewable:
                summary: token.indexing.unviewable event
                description: |
                  Fired when a token becomes unviewable (metadata/enrichment failed or media URLs are unhealthy).
                  This indicates the token cannot be properly displayed due to broken or missing media assets.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J4B"
                  event_type: "token.indexing.unviewable"
                  timestamp: "2024-01-15T10:30:20Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:5678"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "5678"
                    address: "0xowner456"
              tokenIndexingProvenanceCompleted:
                summary: token.indexing.provenance_completed event
                description: |
                  Fired when full provenance history is indexed.
                  After this event, all historical transfers and events are available.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J5"
                  event_type: "token.indexing.provenance_completed"
                  timestamp: "2024-01-15T10:31:30Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "1234"
                    address: null
              tokenOwnershipMinted:
                summary: token.ownership.minted event
                description: |
                  Fired when a token is minted. The `from_address` is null (or zero address), `to_address` is the recipient.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J6"
                  event_type: "token.ownership.minted"
                  timestamp: "2024-01-15T10:30:00Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:5678"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "5678"
                    from_address: null
                    to_address: "0xnewowner123"
                    quantity: "1"
              tokenOwnershipTransferred:
                summary: token.ownership.transferred event
                description: |
                  Fired when a token is transferred. Both `from_address` and `to_address` are populated.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J7"
                  event_type: "token.ownership.transferred"
                  timestamp: "2024-01-15T11:00:00Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "1234"
                    from_address: "0xoldowner123"
                    to_address: "0xnewowner456"
                    quantity: "1"
              tokenOwnershipBurned:
                summary: token.ownership.burned event
                description: |
                  Fired when a token is burned. The `from_address` is the previous owner, `to_address` is null (or zero address).
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J8"
                  event_type: "token.ownership.burned"
                  timestamp: "2024-01-15T12:00:00Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:9999"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "9999"
                    from_address: "0xburner123"
                    to_address: null
                    quantity: "1"
              tokenViewabilityChanged:
                summary: token.viewability.changed event
                description: |
                  Fired when a token viewability changed.
                value:
                  event_id: "01HQX5VFQM8Z7YW8NZRHT6K9J9"
                  event_type: "token.viewability.changed"
                  timestamp: "2024-01-15T13:00:00Z"
                  data:
                    token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
                    chain: "eip155:1"
                    standard: "erc721"
                    contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
                    token_number: "1234"
                    is_viewable: true
      responses:
        '200':
          description: |
            Your endpoint should return 200 (or any 2xx status) to acknowledge receipt.
            This tells the indexer the webhook was successfully delivered.
        '401':
          description: |
            Return 401 if signature verification fails.
        '500':
          description: |
            Server errors will trigger automatic retries with exponential backoff.

components:
  schemas:
    Chain:
      type: string
      description: |
        Blockchain network identifier using CAIP-2 format.
        
        Supported chains:
        - `eip155:1` - Ethereum Mainnet
        - `eip155:11155111` - Ethereum Sepolia (testnet)
        - `tezos:mainnet` - Tezos Mainnet
        - `tezos:ghostnet` - Tezos Ghostnet (testnet)
      enum:
        - eip155:1
        - eip155:11155111
        - tezos:mainnet
        - tezos:ghostnet
      example: eip155:1

    ChainStandard:
      type: string
      description: |
        Blockchain token standard.
        
        Supported standards:
        - `erc721` - Ethereum ERC-721 (non-fungible token)
        - `erc1155` - Ethereum ERC-1155 (multi-token)
        - `fa2` - Tezos FA2 (Financial Application 2)
      enum:
        - erc721
        - erc1155
        - fa2
      example: erc721

    SubjectType:
      type: string
      description: |
        Type of entity that was changed in the changes journal.
        
        Subject types:
        - `token` - Change to token data (mint, burn, etc.)
        - `owner` - Change in token ownership (transfer)
        - `balance` - Change in token balance (for ERC1155/FA2)
        - `metadata` - Change in token metadata
        - `enrich_source` - Change in enrichment source data
        - `media_asset` - Change in media asset status or URLs
      enum:
        - token
        - owner
        - balance
        - metadata
        - enrich_source
        - media_asset
      example: token

    ProvenanceEventType:
      type: string
      description: |
        Type of provenance event.
        
        Event types:
        - `mint` - Token creation/minting
        - `transfer` - Token ownership transfer
        - `burn` - Token destruction
        - `metadata_update` - Metadata was updated on-chain
      enum:
        - mint
        - transfer
        - burn
        - metadata_update
      example: mint

    EnrichmentLevel:
      type: string
      description: |
        Level of metadata enrichment applied.
        
        Enrichment levels:
        - `none` - No enrichment applied
        - `origin` - Basic on-chain metadata only
        - `vendor` - Enriched with vendor API data
        - `enhanced` - Fully enhanced with all available data
      example: vendor

    TokenResponse:
      type: object
      required:
        - id
        - token_cid
        - chain
        - standard
        - contract_address
        - token_number
        - burned
        - viewable
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database token ID (can be used for filtering with token_id parameter)
          example: 12345
        token_cid:
          type: string
          description: Canonical token identifier in format `{chain}:{standard}:{contract_address}:{token_number}`
          example: "eip155:1:erc721:0xabc123:1234"
        chain:
          $ref: '#/components/schemas/Chain'
        standard:
          $ref: '#/components/schemas/ChainStandard'
        contract_address:
          type: string
          description: Smart contract address
          example: "0xabc123def456"
        token_number:
          type: string
          description: Token number within the contract as a string (supports large numbers, can be used for filtering with token_number parameter)
          example: "1234"
        current_owner:
          type: [string, "null"]
          description: Current owner address (null for multi-owner tokens like ERC1155/FA2)
          example: "0xowner123"
        burned:
          type: boolean
          description: Whether the token has been burned
          example: false
        viewable:
          type: boolean
          description: Whether the token has accessible media URLs
          example: true
        created_at:
          type: string
          format: date-time
          description: Timestamp when the token was first indexed
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the token was last updated
          example: "2024-01-02T12:00:00Z"
        metadata:
          anyOf:
            - $ref: '#/components/schemas/TokenMetadataResponse'
            - type: "null"
        owners:
          anyOf:
            - $ref: '#/components/schemas/PaginatedOwners'
            - type: "null"
        provenance_events:
          anyOf:
            - $ref: '#/components/schemas/PaginatedProvenanceEvents'
            - type: "null"
        enrichment_source:
          anyOf:
            - $ref: '#/components/schemas/EnrichmentSourceResponse'
            - type: "null"
          description: Enrichment data from vendor APIs (requires enrichment_source expansion)
        display:
          anyOf:
            - $ref: '#/components/schemas/TokenDisplayResponse'
            - type: "null"
          description: Unified display field merging metadata and enrichment source (requires display expansion). Enrichment source takes precedence over metadata when both have the same field.
        media_assets:
          anyOf:
            - type: array
              items:
                $ref: '#/components/schemas/MediaAssetResponse'
            - type: "null"
          description: |
            Unified media assets array (requires media_asset expansion).
            
            Content depends on which other expansions are requested:
            - With `metadata`: includes media assets from metadata
            - With `enrichment_source`: includes media assets from enrichment source  
            - With `display`: includes only media assets for URLs in the merged display field
            - With `metadata` + `enrichment_source`: includes media from both sources
            - With `metadata` + `display`: includes media from metadata + display merged URLs
            - Without any source expansion: returns empty array
        metadata_media_assets:
          anyOf:
            - type: array
              items:
                $ref: '#/components/schemas/MediaAssetResponse'
            - type: "null"
          description: (Deprecated) Media assets for token metadata only (requires both metadata_media_assets AND metadata expansions). Use media_asset expansion instead.
        enrichment_source_media_assets:
          anyOf:
            - type: array
              items:
                $ref: '#/components/schemas/MediaAssetResponse'
            - type: "null"
          description: (Deprecated) Media assets for enrichment source only (requires both enrichment_source_media_assets AND enrichment_source expansions). Use media_asset expansion instead.

    TokenMetadataResponse:
      type: object
      required:
        - token_id
        - enrichment_level
      properties:
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        origin_json:
          type: [object, "null"]
          description: Original on-chain metadata JSON
          example: {"name": "Token #1234", "description": "Original metadata"}
        latest_json:
          type: [object, "null"]
          description: Latest enriched metadata JSON
          example: {"name": "Token #1234", "description": "Enriched metadata", "artist": "Artist Name"}
        latest_hash:
          type: [string, "null"]
          description: Hash of the latest metadata
          example: "abc123hash"
        enrichment_level:
          $ref: '#/components/schemas/EnrichmentLevel'
        last_refreshed_at:
          type: [string, "null"]
          format: date-time
          description: Timestamp when metadata was last refreshed
          example: "2024-01-02T12:00:00Z"
        image_url:
          type: [string, "null"]
          description: Primary image URL
          example: "https://example.com/image.png"
        animation_url:
          type: [string, "null"]
          description: Animation/video URL
          example: "https://example.com/animation.mp4"
        name:
          type: [string, "null"]
          description: Token name
          example: "Token #1234"
        description:
          type: [string, "null"]
          description: Token description
          example: "A unique digital artwork"
        artists:
          type: array
          items:
            $ref: '#/components/schemas/ArtistResponse'
          description: List of artists/creators
        publisher:
          anyOf:
            - $ref: '#/components/schemas/PublisherResponse'
            - type: "null"
        mime_type:
          type: [string, "null"]
          description: MIME type of the animation_url or image_url 
          example: "image/png"
        created_at:
          type: string
          format: date-time
          description: Timestamp when the token metadata was created
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the token metadata was last updated
          example: "2024-01-02T12:00:00Z"

    ArtistResponse:
      type: object
      properties:
        did:
          type: string
          description: Decentralized identifier for the artist
          example: "did:pkh:tez:tz1abc123"
        name:
          type: string
          description: Artist name
          example: "Artist Name"

    PublisherResponse:
      type: object
      properties:
        name:
          type: [string, "null"]
          description: Publisher name
          example: "Feral File"
        url:
          type: [string, "null"]
          description: Publisher URL
          example: "https://feralfile.com"

    TokenDisplayResponse:
      type: object
      description: |
        Unified token display data that merges metadata and enrichment source.
        Enrichment source takes precedence over metadata when both have the same field.
        
        This field is populated when the `display` expansion is requested.
        When `display` is requested without explicit `metadata` or `enrichment_source` expansions,
        the individual metadata and enrichment_source fields will be null (cleaned up),
        but their data is merged into this display field.
      properties:
        image_url:
          type: [string, "null"]
          description: Primary image URL (from enrichment source if available, otherwise from metadata)
          example: "https://example.com/image.png"
        animation_url:
          type: [string, "null"]
          description: Animation/video URL (from enrichment source if available, otherwise from metadata)
          example: "https://example.com/animation.mp4"
        name:
          type: [string, "null"]
          description: Token name (from enrichment source if available, otherwise from metadata)
          example: "Token #1234"
        description:
          type: [string, "null"]
          description: Token description (from enrichment source if available, otherwise from metadata)
          example: "A unique digital artwork"
        publisher:
          anyOf:
            - $ref: '#/components/schemas/PublisherResponse'
            - type: "null"
          description: Publisher information (from metadata, as enrichment sources don't provide publisher)
        artists:
          type: array
          items:
            $ref: '#/components/schemas/ArtistResponse'
          description: List of artists/creators (from enrichment source if available, otherwise from metadata)
        mime_type:
          type: [string, "null"]
          description: MIME type of the animation_url or image_url (from enrichment source if available, otherwise from metadata)
          example: "image/png"

    OwnerResponse:
      type: object
      required:
        - owner_address
        - quantity
        - created_at
        - updated_at
      properties:
        owner_address:
          type: string
          description: Owner's blockchain address
          example: "0xowner123"
        quantity:
          type: string
          description: Quantity owned (as string to support large numbers)
          example: "1"
        created_at:
          type: string
          format: date-time
          description: Timestamp when ownership was first recorded
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when ownership was last updated
          example: "2024-01-02T12:00:00Z"

    PaginatedOwners:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/OwnerResponse'
          description: List of owners
        offset:
          type: [integer, "null"]
          format: uint64
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of owners
          example: 100

    ProvenanceEventResponse:
      type: object
      required:
        - id
        - token_id
        - chain
        - event_type
        - timestamp
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database ID
          example: 67890
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        chain:
          $ref: '#/components/schemas/Chain'
        event_type:
          $ref: '#/components/schemas/ProvenanceEventType'
        from_address:
          type: [string, "null"]
          description: Sender address (null for mint events)
          example: "0xfrom123"
        to_address:
          type: [string, "null"]
          description: Recipient address (null for burn events)
          example: "0xto456"
        quantity:
          type: [string, "null"]
          description: Quantity transferred (as string to support large numbers)
          example: "1"
        tx_hash:
          type: [string, "null"]
          description: Transaction hash
          example: "0xtxhash123"
        block_number:
          type: [integer, "null"]
          format: uint64
          description: Block number
          example: 12345678
        block_hash:
          type: [string, "null"]
          description: Block hash
          example: "0xblockhash456"
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
          example: "2024-01-01T00:00:00Z"
        raw:
          type: [object, "null"]
          description: Raw event data as JSON
          example: {"log_index": 10, "transaction_index": 5}
        created_at:
          type: string
          format: date-time
          description: Timestamp when event was indexed
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when event was last updated
          example: "2024-01-01T00:00:00Z"

    PaginatedProvenanceEvents:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ProvenanceEventResponse'
          description: List of provenance events
        offset:
          type: [integer, "null"]
          format: uint64
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of events
          example: 50

    EnrichmentSourceResponse:
      type: object
      required:
        - token_id
        - vendor
        - created_at
        - updated_at
      properties:
        token_id:
          type: integer
          format: uint64
          description: Reference to the token
          example: 12345
        vendor:
          type: string
          description: Vendor/source name (e.g., "artblocks", "fxhash")
          example: "artblocks"
        vendor_json:
          type: [object, "null"]
          description: Raw vendor API response as JSON
          example: {"project_name": "Chromie Squiggle", "series": 0}
        vendor_hash:
          type: [string, "null"]
          description: Hash of vendor data
          example: "vendor123hash"
        image_url:
          type: [string, "null"]
          description: Image URL from vendor
          example: "https://vendor.com/image.png"
        animation_url:
          type: [string, "null"]
          description: Animation URL from vendor
          example: "https://vendor.com/animation.mp4"
        name:
          type: [string, "null"]
          description: Token name from vendor
          example: "Chromie Squiggle #1234"
        description:
          type: [string, "null"]
          description: Token description from vendor
          example: "A unique generative artwork"
        artists:
          type: array
          items:
            $ref: '#/components/schemas/ArtistResponse'
          description: Artists from vendor data
        mime_type:
          type: [string, "null"]
          description: MIME type of the animation_url or image_url from vendor
          example: "image/png"
        created_at:
          type: string
          format: date-time
          description: Timestamp when enrichment was created
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when enrichment was last updated
          example: "2024-01-02T12:00:00Z"

    MediaAssetResponse:
      type: object
      required:
        - id
        - source_url
        - provider
        - variant_urls
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: int64
          description: Internal database media asset ID
          example: 12345
        source_url:
          type: string
          description: Original source URL of the media asset
          example: "ipfs://QmXyzAbc123/image.png"
        mime_type:
          type: [string, "null"]
          description: MIME type of the media asset
          example: "image/png"
        file_size_bytes:
          type: [integer, "null"]
          format: int64
          description: File size in bytes
          example: 1024000
        provider:
          type: string
          description: Storage provider (e.g., "cloudflare")
          example: "cloudflare"
        provider_asset_id:
          type: [string, "null"]
          description: Asset ID in the provider's system
          example: "1234567890"
        provider_metadata:
          type: [object, "null"]
          description: Additional metadata from the provider
          example: {"account_id": "1234567890"}
        variant_urls:
          type: object
          description: Different variants/sizes of the media asset
          example: {"x": "https://cdn.example.com/thumb.jpg", "xl": "https://cdn.example.com/medium.jpg"}
        created_at:
          type: string
          format: date-time
          description: Timestamp when the media asset was created
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the media asset was last updated
          example: "2024-01-02T12:00:00Z"

    TokenListResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TokenResponse'
          description: List of tokens
        offset:
          type: [integer, "null"]
          format: uint64
          description: Next offset for pagination (null if there are no more results)
          example: 0

    ChangeResponse:
      type: object
      required:
        - id
        - token_cid
        - subject_type
        - subject_id
        - changed_at
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: uint64
          description: Internal database ID
          example: 99999
        token_cid:
          type: string
          description: Token CID that was affected
          example: "eip155:1:erc721:0xabc123:1234"
        subject_type:
          $ref: '#/components/schemas/SubjectType'
        subject_id:
          type: string
          description: |
            Polymorphic reference to the subject that changed:
            - For 'token'/'owner': provenance_event_id
            - For 'balance': balance_id
            - For 'metadata': token_id
            - For 'media': media_asset_id
          example: "67890"
        changed_at:
          type: string
          format: date-time
          description: Timestamp when the change occurred
          example: "2024-01-02T12:00:00Z"
        meta:
          type: [object, "null"]
          description: Additional context about the change as JSON
          example: {"fields_changed": ["name", "description"]}
        created_at:
          type: string
          format: date-time
          description: Timestamp when change was recorded
          example: "2024-01-02T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when change was last updated
          example: "2024-01-02T12:00:00Z"
        subject:
          description: Expanded subject data (available when expand=subject)
          oneOf:
            - $ref: '#/components/schemas/TokenResponse'
            - $ref: '#/components/schemas/OwnerResponse'
            - $ref: '#/components/schemas/TokenMetadataResponse'
            - type: "null"

    ChangeListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ChangeResponse'
          description: List of changes
        offset:
          type: [integer, "null"]
          format: uint64
          description: Current offset for pagination
          example: 0
        total:
          type: integer
          format: uint64
          description: Total number of changes matching the filter
          example: 500

    TriggerTokenIndexingRequest:
      type: object
      required:
        - token_cids
      properties:
        token_cids:
          type: array
          items:
            type: string
          description: List of token CIDs to index (max 20, required)
          minItems: 1
          maxItems: 20
          example: ["eip155:1:erc721:0xabc123:1234", "eip155:1:erc721:0xabc123:5678"]

    TriggerOwnerIndexingRequest:
      type: object
      required:
        - addresses
      properties:
        addresses:
          type: array
          items:
            type: string
          description: List of owner addresses to index all tokens for (max 5, required)
          minItems: 1
          maxItems: 5
          example: ["0xowner123", "tz1abc123"]

    TriggerMetadataIndexingRequest:
      type: object
      description: |
        Request to trigger metadata refresh for tokens.
        
        At least one of `token_ids` or `token_cids` must be provided.
        Both can be provided together, and duplicate CIDs will be automatically deduplicated.
      properties:
        token_ids:
          type: array
          items:
            type: integer
            format: uint64
          description: |
            List of internal database token IDs to refresh metadata for (max 20, optional).
            All provided IDs must exist in the database.
          minItems: 1
          maxItems: 50
          example: [12345, 67890]
        token_cids:
          type: array
          items:
            type: string
          description: |
            List of token CIDs to refresh metadata for (max 20, optional).
            All provided CIDs must exist in the database.
            Format: `{chain}:{standard}:{contract_address}:{token_number}`
          minItems: 1
          maxItems: 50
          example: ["eip155:1:erc721:0xabc123:1234", "tezos:mainnet:fa2:KT1abc123:5678"]
      example:
        token_ids: [12345, 67890]
        token_cids: ["eip155:1:erc721:0xabc123:1234"]

    TriggerIndexingResponse:
      type: object
      required:
        - workflow_id
        - run_id
      properties:
        workflow_id:
          type: string
          description: Temporal workflow ID for tracking
          example: "index-workflow-123"
        run_id:
          type: string
          description: Temporal run ID for tracking
          example: "run-456"

    AddressIndexingJobInfo:
      type: object
      required:
        - address
        - workflow_id
      properties:
        address:
          type: string
          description: The wallet address being indexed
          example: "tz1abc123..."
        workflow_id:
          type: string
          description: Temporal workflow ID for tracking this address's indexing job
          example: "index-token-owner-tz1abc123..."

    TriggerAddressIndexingResponse:
      type: object
      required:
        - jobs
      properties:
        jobs:
          type: array
          description: List of indexing jobs, one per address
          items:
            $ref: '#/components/schemas/AddressIndexingJobInfo'
          example:
            - address: "tz1abc123..."
              workflow_id: "index-token-owner-tz1abc123..."
            - address: "0x1234..."
              workflow_id: "index-token-owner-0x1234..."

    WorkflowStatusResponse:
      type: object
      required:
        - workflow_id
        - run_id
        - status
      properties:
        workflow_id:
          type: string
          description: Temporal workflow ID
          example: "index-workflow-123"
        run_id:
          type: string
          description: Temporal run ID
          example: "run-456"
        status:
          type: string
          description: |
            Current status of the workflow execution.
            
            Possible values:
            - WORKFLOW_EXECUTION_STATUS_RUNNING - Workflow is currently running
            - WORKFLOW_EXECUTION_STATUS_COMPLETED - Workflow completed successfully
            - WORKFLOW_EXECUTION_STATUS_FAILED - Workflow failed with an error
            - WORKFLOW_EXECUTION_STATUS_CANCELED - Workflow was canceled
            - WORKFLOW_EXECUTION_STATUS_TERMINATED - Workflow was terminated
            - WORKFLOW_EXECUTION_STATUS_CONTINUED_AS_NEW - Workflow continued as new
            - WORKFLOW_EXECUTION_STATUS_TIMED_OUT - Workflow timed out
          example: "WORKFLOW_EXECUTION_STATUS_COMPLETED"
        start_time:
          type: string
          format: date-time
          description: Workflow start time in RFC3339 format
          example: "2024-01-15T10:30:00Z"
        close_time:
          type: string
          format: date-time
          description: Workflow close time in RFC3339 format (only present if workflow is closed)
          example: "2024-01-15T10:35:00Z"
        execution_time_ms:
          type: integer
          format: uint64
          description: Total execution time in milliseconds (only present if workflow is closed)
          example: 300000

    AddressIndexingJobResponse:
      type: object
      required:
        - workflow_id
        - address
        - chain
        - status
        - tokens_processed
        - started_at
      properties:
        workflow_id:
          type: string
          description: Orchestrator workflow ID for this indexing job
          example: "index-token-owner-0x1234567890123456789012345678901234567890"
        address:
          type: string
          description: Blockchain address being indexed
          example: "0x1234567890123456789012345678901234567890"
        chain:
          $ref: '#/components/schemas/Chain'
        status:
          type: string
          description: |
            Current status of the indexing job.
            
            Possible values:
            - running - Job is currently running
            - paused - Job paused (quota exhausted, will resume after quota reset)
            - failed - Job failed with an error
            - completed - Job completed successfully
            - canceled - Job was canceled
          enum:
            - running
            - paused
            - failed
            - completed
            - canceled
          example: "running"
        tokens_processed:
          type: integer
          description: Number of tokens processed so far (tracks progress during indexing)
          example: 150
        total_tokens_indexed:
          type: integer
          description: |
            Optional: Total tokens owned by the address (present in database).
            Only included if requested via query parameters (include_totals or include_total_indexed).
            Represents the complete ownership count for this address.
          example: 500
        total_tokens_viewable:
          type: integer
          description: |
            Optional: Total tokens with metadata OR enrichment source (ready for display).
            Only included if requested via query parameters (include_totals or include_total_viewable).
            Represents tokens that have visual metadata and can be shown in a UI.
          example: 450
        current_min_block:
          type: integer
          format: uint64
          description: Current minimum block indexed (null if not yet started)
          example: 12000000
        current_max_block:
          type: integer
          format: uint64
          description: Current maximum block indexed (null if not yet started)
          example: 19000000
        started_at:
          type: string
          format: date-time
          description: When the job started
          example: "2024-01-15T10:30:00Z"
        paused_at:
          type: string
          format: date-time
          description: When the job was paused (null if not paused)
          example: "2024-01-15T10:35:00Z"
        completed_at:
          type: string
          format: date-time
          description: When the job completed (null if not completed)
          example: "2024-01-15T10:40:00Z"
        failed_at:
          type: string
          format: date-time
          description: When the job failed (null if not failed)
          example: "2024-01-15T10:40:00Z"
        canceled_at:
          type: string
          format: date-time
          description: When the job was canceled (null if not canceled)
          example: null

    CreateWebhookClientRequest:
      type: object
      required:
        - webhook_url
        - event_filters
      properties:
        webhook_url:
          type: string
          format: uri
          description: HTTPS endpoint where webhooks will be delivered (must be HTTPS)
          example: "https://example.com/webhooks/handler"
        event_filters:
          type: array
          items:
            type: string
          description: |
            List of event types this client wants to receive.
            Use `["*"]` to receive all event types.
            
            Available event types:
            
            **Indexing Events** (fired during token indexing workflow):
            - `token.indexing.queryable` - Token becomes queryable (fired after token and minimal provenances are indexed)
            - `token.indexing.viewable` - Token becomes viewable (fired after metadata and enrichment are complete, media URLs are healthy)
            - `token.indexing.unviewable` - Token becomes unviewable (fired when metadata/enrichment fails or media URLs are unhealthy)
            - `token.indexing.provenance_completed` - Full provenance indexed (fired after all historical transfers are indexed)
            
            **Ownership Events** (fired during ownership change workflows):
            - `token.ownership.minted` - Token was minted (fired when mint event is processed)
            - `token.ownership.transferred` - Token ownership changed (fired when transfer event is processed)
            - `token.ownership.burned` - Token was burned (fired when burn event is processed)
            
            **Wildcard**:
            - `*` - Wildcard for all events
          minItems: 1
          example: ["token.indexing.viewable", "token.ownership.transferred"]
        retry_max_attempts:
          type: integer
          minimum: 0
          maximum: 10
          default: 5
          description: Maximum number of delivery attempts before giving up (0-10, default 5)
          example: 5

    WebhookClientResponse:
      type: object
      required:
        - client_id
        - webhook_url
        - webhook_secret
        - event_filters
        - is_active
        - retry_max_attempts
        - created_at
        - updated_at
      properties:
        client_id:
          type: string
          format: uuid
          description: Unique identifier for the webhook client (UUID v4)
          example: "550e8400-e29b-41d4-a716-446655440000"
        webhook_url:
          type: string
          format: uri
          description: HTTPS endpoint where webhooks will be delivered
          example: "https://example.com/webhooks/handler"
        webhook_secret:
          type: string
          description: Secret key for HMAC-SHA256 signature verification (64-character hex string)
          example: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234567890"
        event_filters:
          type: array
          items:
            type: string
          description: List of event types this client will receive
          example: ["token.indexing.viewable", "token.ownership.transferred"]
        is_active:
          type: boolean
          description: Whether this client is active and should receive webhooks
          example: true
        retry_max_attempts:
          type: integer
          description: Maximum number of delivery attempts
          example: 5
        created_at:
          type: string
          format: date-time
          description: Timestamp when the webhook client was created
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the webhook client was last updated
          example: "2024-01-15T10:30:00Z"
    
    WebhookEventPayload:
      type: object
      required:
        - event_id
        - event_type
        - timestamp
        - data
      description: |
        The webhook event payload that will be sent to your webhook endpoint.
        
        This is delivered as a POST request to your `webhook_url` with:
        - **Content-Type**: `application/json`
        - **X-Webhook-Signature**: HMAC-SHA256 signature in format `sha256=<hex>`, computed over `{timestamp}.{event_id}.{json_body}`
        - **X-Webhook-Event-ID**: The unique event ID (ULID format)
        - **X-Webhook-Event-Type**: The event type string
        - **X-Webhook-Timestamp**: Unix timestamp (used in signature computation)
      properties:
        event_id:
          type: string
          description: Unique event identifier (ULID format - time-sortable, globally unique)
          example: "01HQX5VFQM8Z7YW8NZRHT6K9J3"
        event_type:
          type: string
          description: Type of webhook event
          enum:
            - token.indexing.queryable
            - token.indexing.viewable
            - token.indexing.unviewable
            - token.indexing.provenance_completed
            - token.ownership.minted
            - token.ownership.transferred
            - token.ownership.burned
            - token.viewability.changed
          example: "token.indexing.viewable"
        timestamp:
          type: string
          format: date-time
          description: When the event was generated (RFC3339 format)
          example: "2024-01-15T10:30:00Z"
        data:
          description: Event-specific payload data
          oneOf:
            - $ref: '#/components/schemas/WebhookIndexingEventData'
            - $ref: '#/components/schemas/WebhookOwnershipEventData'
            - $ref: '#/components/schemas/WebhookViewabilityChangedEventData'
    
    WebhookIndexingEventData:
      type: object
      required:
        - token_cid
        - chain
        - standard
        - contract
        - token_number
      description: |
        Data payload for indexing events:
        - `token.indexing.queryable` - Fired after token and minimal provenances are indexed. The token can now be queried by ID, and basic ownership information is available.
        - `token.indexing.viewable` - Fired after metadata and enrichment are complete, and media URLs are healthy. The token now has full metadata, enrichment data, and is ready for display.
        - `token.indexing.unviewable` - Fired when metadata/enrichment fails or media URLs are unhealthy. The token cannot be properly displayed due to broken or missing media assets.
        - `token.indexing.provenance_completed` - Fired after full provenance history is indexed. All historical transfers and events are now available.
      properties:
        token_cid:
          type: string
          description: Canonical token identifier
          example: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain:
          type: string
          description: Blockchain network identifier (CAIP-2 format)
          example: "eip155:1"
        standard:
          type: string
          description: Token standard (erc721, erc1155, fa2)
          enum: [erc721, erc1155, fa2]
          example: "erc721"
        contract:
          type: string
          description: Smart contract address
          example: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number:
          type: string
          description: Token number/ID within the contract
          example: "1234"
        address:
          type: [string, "null"]
          description: |
            Address that triggered the indexing operation (if any).
            This will be populated when indexing was triggered by a specific address
            (e.g., via the owner indexing API endpoint).
          example: "0xowner123"
      example:
        token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain: "eip155:1"
        standard: "erc721"
        contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number: "1234"
        address: null
    
    WebhookOwnershipEventData:
      type: object
      required:
        - token_cid
        - chain
        - standard
        - contract
        - token_number
        - quantity
      description: |
        Data payload for ownership events:
        - `token.ownership.minted` - Fired when a token is minted. `from_address` will be null, `to_address` is the recipient.
        - `token.ownership.transferred` - Fired when a token is transferred. Both `from_address` and `to_address` are populated.
        - `token.ownership.burned` - Fired when a token is burned. `from_address` is the previous owner, `to_address` will be null.
      properties:
        token_cid:
          type: string
          description: Canonical token identifier
          example: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain:
          type: string
          description: Blockchain network identifier (CAIP-2 format)
          example: "eip155:1"
        standard:
          type: string
          description: Token standard (erc721, erc1155, fa2)
          enum: [erc721, erc1155, fa2]
          example: "erc721"
        contract:
          type: string
          description: Smart contract address
          example: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number:
          type: string
          description: Token number/ID within the contract
          example: "1234"
        from_address:
          type: [string, "null"]
          description: |
            Sender address (null for mint events).
            For transfers: the previous owner.
            For burns: the owner who burned the token.
          example: "0xfrom123"
        to_address:
          type: [string, "null"]
          description: |
            Recipient address (null for burn events).
            For mints: the new owner.
            For transfers: the new owner.
          example: "0xto456"
        quantity:
          type: string
          description: Quantity transferred (as string to support large numbers). Usually "1" for ERC721/FA2, can be larger for ERC1155.
          example: "1"
      example:
        token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain: "eip155:1"
        standard: "erc721"
        contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number: "1234"
        from_address: "0xfrom123"
        to_address: "0xto456"
        quantity: "1"
    WebhookViewabilityChangedEventData:
      type: object
      required:
        - token_cid
        - chain
        - standard
        - contract
        - token_number
        - is_viewable
      properties:
        token_cid:
          type: string
          description: Canonical token identifier
          example: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain:
          type: string
          description: Blockchain network identifier (CAIP-2 format)
          example: "eip155:1"
        standard:
          type: string
          description: Token standard (erc721, erc1155, fa2)
          enum: [erc721, erc1155, fa2]
          example: "erc721"
        contract:
          type: string
          description: Smart contract address
          example: "0xa7d8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number:
          type: string
          description: Token number/ID within the contract
          example: "1234"
        is_viewable:
          type: string
          description: Whether the token is viewable
          example: true
      example:
        token_cid: "eip155:1:erc721:0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270:1234"
        chain: "eip155:1"
        standard: "erc721"
        contract: "0xa7d8d9ef8d8ce8992df33d8b8cf4aebabd5bd270"
        token_number: "1234"
        is_viewable: true

    APIError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          enum:
            - bad_request
            - not_found
            - validation_failed
            - unauthorized
            - forbidden
            - internal_error
            - database_error
            - service_error
          example: validation_failed
        message:
          type: string
          description: Human-readable error message
          example: "Validation failed"
        details:
          type: string
          description: Additional error details
          example: "Invalid token CID format"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT authentication using RSA signing algorithms (RS256, RS384, or RS512).
        
        Include the JWT token in the Authorization header:
        ```
        Authorization: Bearer <your-jwt-token>
        ```
        
        The token must include standard claims:
        - `exp` (expiration time) - Token must not be expired
        - `nbf` (not before) - Token must be currently valid
        - `sub` (subject) - Optional, identifies the authenticated user/service
        
        Example:
        ```
        Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        ```
    
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        API Key authentication.
        
        Include the API key in the Authorization header with 'ApiKey' prefix:
        ```
        Authorization: ApiKey <your-api-key>
        ```
        
        Example:
        ```
        Authorization: ApiKey abc123def456...
        ```
